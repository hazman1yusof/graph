<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Flot Examples: Error Bars</title>
	<link href="asset/css/examples.css" rel="stylesheet" type="text/css">
	<link href="asset/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
	<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../../excanvas.min.js"></script><![endif]-->
	<script language="javascript" type="text/javascript" src="asset/jquery-1.12.4.min.js"></script>
	<script language="javascript" type="text/javascript" src="asset/flot/jquery.flot.js"></script>
	<script language="javascript" type="text/javascript" src="asset/flot/jquery.flot.errorbars.js"></script>
	<script language="javascript" type="text/javascript" src="asset/flot/jquery.flot.navigate.js"></script>
	<script language="javascript" type="text/javascript" src="asset/flot/jquery.flot.crosshair.js"></script>
	<script language="javascript" type="text/javascript" src="asset/flot/jquery.flot.symbol.js"></script>
	<script language="javascript" type="text/javascript" src="asset/jquery.csv.min.js"></script>
	<script language="javascript" type="text/javascript" src="asset/moment.js"></script>
	<script language="javascript" type="text/javascript" src="asset/bootstrap/js/bootstrap.min.js"></script>

	<style type="text/css">
		.sistole{color: blue}
		.diastole{color: blue}
		.pulse{color: red}
		.temp{color: orange}

		#placeholder3 .y1Axis{
			line-height: 1;
		}

	</style>

	<script type="text/javascript">

	$(function() {

		var sistole=[],diastole=[],pulse=[],temp=[],tick1=[],tick2=[],time=[];

		fetchdata(all=true);
		function fetchdata(all,datefr_,dateto_){
			fetch('file.txt')
				.then(response => response.text())
				.then(function(data){
					var obj = $.csv.toObjects(data);
					var sis_dis =  obj.map(function(value,i){
						var diff = (parseFloat(value.sistole) - parseFloat(value.diastole)) / 2;
						var center = parseFloat(value.sistole) - parseFloat(diff);
						if(all){
							return [i+1,center,diff];
						}else{
							// let datefr = moment(datefr_, "YYYY-MM-DD");
							// let dateto_ = moment(dateto_, "YYYY-MM-DD");
							let mom = moment(value.time, "YYYY-MM-DD HH:mm:ss");
							if(mom.isBetween(datefr_,dateto_)){
								return [i+1,center,diff];
							}
						}
					});
					var pulse = obj.map(function(value,i){
						if(all){return [i+1,value.pulse];}
					});
					var temp = obj.map(function(value,i){
						if(all){return [i+1,value.temp];}
					});
					var tick1 = obj.map(function(value,i){
						if(all){return [i+1,value.tick1];}
					});
					var tick2 = obj.map(function(value,i){
						if(all){return [i+1,value.tick2];}
					});
					var time = obj.map(function(value,i){
						if(all){return [i+1,value.time];}
					});
					doPlot(temp.length+1,sis_dis,pulse,temp,tick1,tick2,time);
					xAxisReplot();
				});
		}

		var plot;
		function doPlot(x,sis_dis,pulse,temp,tick1,tick2,time){
			var data_points = {
				//do not show points
				radius: 0,
				errorbars: "y", 
				yerr: {show:true, upperCap: drawArrow2, lowerCap: drawArrow, radius: 5, lineWidth: 2.5}
			};

			var data = [
				{color: "blue", lines: {show: false}, points: data_points, data: sis_dis, label: "Blood Pressure", yaxis: 1},
				{color: "red", lines: {show: true, lineWidth: 0.5}, points: {show:true}, data: pulse, label: "Pulse", yaxis: 1},
				{color: "orange", lines: {show: true, lineWidth: 1}, points: {show:true}, data: temp, label: "Temperature", yaxis: 2}
			];

			plot = $.plot($("#placeholder"), data , {
				legend: {show: true},
				crosshair: {mode: "x"},
				grid: {
					hoverable: true,
					autoHighlight: false
				},
				xaxes: [{
					min: 0.5,
					max: x-.5,
					ticks: tick_time(x-1,time)
				}],
				yaxes: [{
							min: 30,
							max: 180,
							ticks: tick_yaxis(180,30,nbsp(23))
						},{
							// align if we are to the right
							min: -35,
							max: 60,
							ticks: tick_yaxis(-35,60,nbsp(0)),
							alignTicksWithAxis: 3,
							position: 'right'
						}],
			});

			plot2 = $.plot($("#placeholder2"),[{color: "black", points: {symbol:"cross",show:true}, data: tick1, label: "Best Motor Response"}],{
				legend: {show: true},
				xaxes: [{
					min: 0.5,
					max: x-.5,
					ticks: ticktengah(x,nbsp(10))
				}],
				yaxes: [{
					min: 0.5,
					max: 6.5,
					ticks: [[0.5,"<span class='yaxis'>flaccid</br></br></span>"],
							[1.5,"Extension</br></br>"],
							[2.5,"Abnormal Flexion</br></br>"],
							[3.5,"Flexor withdrawal</br></br>"],
							[4.5,"Localise pain</br></br>"],
							[5.5,"Obey commands</br></br>"],
							[6.5,""]]
				}],
				grid: {hoverable:true}

			});

			plot2 = $.plot($("#placeholder3"),[{color: "black", points: {symbol:"cross",show:true}, data: tick2, label: "Best Verbal Response"}],{
				legend: {show: true},
				xaxes: [{
					min: 0.5,
					max: x-.5,
					ticks: ticktengah(x,nbsp(10))
				}],
				yaxes: [{
					min: 0.5,
					max: 5.5,
					ticks: [[0.5,"None</br></br>"],
							[1.5,"Incomprehensible</br>Sounds</br></br>"],
							[2.5,"Inappropriate<br>Words</br></br>"],
							[3.5,"Confused</br></br>"],
							[4.5,"Oriented</br></br>"],
							[5.5,""]]
				}],
				grid: {hoverable:true}

			});
		}

		$("<div id='tooltip'></div>").css({
			'font-size' : '0.8rem',
			'font-weight' : 'bold',
			'border-radius' : '.28571429rem',
			position: "absolute",
			display: "none",
			border: "2px solid #bababc",
			padding: "2px",
			"background-color": "#bababc",
			opacity: 0.70
		}).appendTo("body");

		function updateLegend() {
			updateLegendTimeout = null;
			var pos = latestPosition;
			var axes = plot.getAxes();
			if (pos.x < axes.xaxis.min || pos.x > axes.xaxis.max ||pos.y < axes.yaxis.min || pos.y > axes.yaxis.max) {
				$("#tooltip").hide(); return;
			}
			var i, j, arr = [], dataset = plot.getData();

			for (i = 0; i < dataset.length; ++i) {
				var series = dataset[i];
				// Find the nearest points, x-wise
				for (j = 1; j < series.data.length; ++j) {
					if (series.data[j][0] > pos.x + .5 ) {
						break;
					}
				}
				var y,p1 = series.data[j - 1],p2 = series.data[j];
				if (p1 == null) {
					y = p2;
				} else if (p2 == null) {
					y = p1;
				} else {
					y = p1;
				}
				arr[i] = y;
			}

			var sistole = parseFloat(arr[0][1]) + parseFloat(arr[0][2]),
				diastole = parseFloat(arr[0][1]) -  parseFloat(arr[0][2]),
				pulse = arr[1][1];
				temp = arr[2][1];

			$("#tooltip").html(`<b>Sistole: </b><span class='sistole'>`+sistole
								+`</span><br/><b>Diastole: </b><span class='diastole'>`+diastole
								+`</span><br/><b>Pulse: </b><span class='pulse'>`+pulse
								+`</span><br/><b>Temperature: </b><span class='temp'>`+temp+`</span>`)
					.css({top: pos.pageY+20, left: pos.pageX+20})
					.fadeIn(500);

		}

		var updateLegendTimeout = null;
		var latestPosition = null;
		$("#placeholder").bind("plothover",  function (event, pos, item) {
			latestPosition = pos;
			if (!updateLegendTimeout) {
				updateLegendTimeout = setTimeout(updateLegend, 50);
			}
		});

		$("#placeholder").mouseout(function() {
			$("#tooltip").hide();
		});

		$('#filter').click(function(){
			let datefr = $('#datefr').val();
			let dateto = $('#dateto').val();
			fetchdata(all=false,datefr_=datefr,dateto_=dateto);
		});

	});

	</script>
	<script language="javascript" type="text/javascript" src="util.js"></script>
</head>
<body>

	<div id="content">
		<form class="alert alert-primary">
			<div class="row">
				<div class="col">
					Date From
					<input type="date" class="form-control" placeholder="Date From" id="datefr">
				</div>
				<div class="col">
					Date To
					<input type="date" class="form-control" placeholder="Date To" id="dateto">
				</div>
				<div class="col">
					<br>
					<label><input type="checkbox" class="" id="customCheck1">Show All Record</label>
					<button class="btn btn-primary float-right" type="button" id="filter">Filter</button>
				</div>
			</div>
		</form>

		<div class="demo-container">
			<div id="placeholder" class="demo-placeholder" style="height: 60%"></div>
			<div id="placeholder2" class="demo-placeholder" style="height: 20%"></div>
			<div id="placeholder3" class="demo-placeholder" style="height: 20%"></div>
		</div>

	</div>
	<!-- <div class="card border-success mb-3" style="width: 10rem;">
	  <div class="card-header">Header</div>
	  <div class="card-body">
	    <h5 class="card-title">Card title</h5>
	    <p class="card-text"><b>sistole</b> 90</p>
	    <p class="card-text"><b>diastole</b> 12</p>
	    <p class="card-text"><b>temp</b> 12</p>
	    <p class="card-text"><b>temp</b> 12</p>
	  </div>
	</div> -->

</body>
</html>
